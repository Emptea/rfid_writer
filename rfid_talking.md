# Общение с меткой в режиме Polling
## Общий вид посылки
**Посылка имеет фиксированный размер 64 байта**

От ПК на устройство поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |reserved | protocol | tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | незначащие байты       

- TID - ID обмена, меняется с каждой отосланной посылкой (для ПК необязательно)
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- tx-prot - количество отосланных байт (для этого пакета) от хоста к устройству
- rx-prot - количество байт, которые ожидается принять (для данного пакета) от устройства

От устройства на ПК поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | незначащие байты  

- TID - ID обмена, меняется с каждой отосланной посылкой
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- HID status - если протокол не был обработан (из-за того что id протокола было незивестно), следующий HID пакет будет содержать байт HID status <> 0, сигнализирующий о произошедшей ошибке (некоторое время назад)
- protocol status - байт, содержащий результат команды, если была отослана команда сгенерировать данные для отправки или команда чтения (MSBit обнулен [has the MSBit cleared]) 
- tx-prot - количество отосланных байт (для этого пакета) от устройства к хосту

## Последовательность общения в режиме Polling
Инициализация общения по протоколу iso14443a -> Чтение -> Деинициализация общения по протоколу iso14443a с rfid_on = 0x01

### Инициализация общения по протоколу iso14443a
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | TID | payload | reserved | protocol |tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| ID команды | незначащие байты
Значение | TID | 0x06 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xa0 | любые значения

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| незначащие байты  
Значение | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | любые значения

### Считывание и вывод полученного uid
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload | reserved | protocol |tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| ID команды | REQA | perform anticollision | незначащие байты
Значение | 0x03 | 0x08 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x11 | 0xa1 | 0x26| 0x01 | любые значения
- perform anticollision - 0x01: предотвращать коллизию, 0x02: не предотвращать

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-10 | 11 | 12-14| 15-25 | 26-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload | HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB | сol | ATQA | cascade level | sak | uid | незначащие байты  
Значение | TID | 0x16 | 0x00 | 0x44 | 0x00 | 0x04 | 0x00 | 0x11 | сol | ATQA | cascade level | sak | uid | любые значения
- col - колонка
- ATQA - код производителя
- cascade level - 1: 4-битный uid, 2: 7-битный, 3: 10-битный
- sak - вид метки
- uid - уникальный id метки, размер задан в cascade level
### Деинициализация общения по протоколу
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |---  |--- 
Содержание | TID | payload | reserved | protocol |tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| ID команды  | rfid_on | незначащие байты
Значение | 0x04 | 0x07 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xaf | rfid_on | любые значения
- rfid_on - 0x01: оставить включенной метку, 0x00: выключить

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | payload | HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| незначащие байты  
Значение | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | любые значения

## Опционально
### Включение/выключение RFID
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload | reserved | protocol |tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| ID команды | on | незначащие байты
Значение | 0x05 | 0x07 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x00 | 0x22 | 0x00 | любые значения
- on - 0x01: вкл; 0x02: выкл

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | payload | HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| незначащие байты 
Значение | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | любые значения