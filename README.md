# rfid_writer
Скрипт на Python для чтения с ST25R3911B-DISCO в режиме polling

# Условности
Посылка может быть не более 64 байт.

Пакет может состоять из нескольких посылок и быть больше 64 байт.

TID при отсылке от хоста фиксировано, на производительность программы не влияет.

# Общий вид посылки
Посылка имеет фиксированный размер 64 байта. При отсылке посылки меньшего размера будет вызвана ошибка средствами pyusb.

На Windows необходимо "добивать" посылку до размера 64 байта, желательно не нулями (для удобства просмотра всей посылки). На Linux, по слухам, посылка добивается самостоятельно.

От ПК на устройство поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |reserved | protocol | tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | 0xcb        

- TID - ID обмена, меняется с каждой отосланной посылкой
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- tx-prot - количество отосланных байт (для этого пакета) от хоста к устройству
- rx-prot - количество байт, которые ожидается принять (для данного пакета) от устройства

От устройства на ПК поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | 0xcb  

- TID - ID обмена, меняется с каждой отосланной посылкой
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- HID status - если протокол не был обработан (из-за того что id протокола было незивестно), следующий HID пакет будет содержать байт HID status <> 0, сигнализирующий о произошедшей ошибке (некоторое время назад)
- protocol status - байт, содержащий результат команды, если была отослана команда сгенерировать данные для отправки или команда чтения (MSBit обнулен [has the MSBit cleared]) 
- tx-prot - количество отосланных байт (для этого пакета) от устройства к хосту


# Команды
## Запись в регистр 0x23
На старте программа отсылает команду на считывание с регистра ST25R3911 под номером 0x23 (код команды считывания с регистра - 0x69):

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | 0x00 | 0x06 | 0x00 | 0x69 | 0x00 | 0x01 | 0x00 | 0x01 | 0x23 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | TID | 0x06 | 0x00 | 0x69 | 0x00 | 0x00 | 0x00 | 0x01 | 0x70 | мусор

Дальнейшие команды отсылаются в цикле.
## Инициализация протокола ISO14443a
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | 0x01 | 0x06 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xa0 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## Включение RFID
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x02 | 0x07 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x00 | 0x22 | 0x01 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## Чтение данных с RFID метки
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x03 | 0x08 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x11 | 0xa1 | 0x26| 0x01 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-10 | 11 | 12-14| 15-25 | 26-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x16 | 0x00 | 0x44 | 0x00 | 0x04 | 0x00 | 0x11 | сol | ATQA | cascade level | sak | uid | мусор
- col - колонка
- ATQA - код производителя
- cascade level - 1: 4-битный uid, 2: 7-битный, 3: 10-битный
- sak - вид метки
- uid - уникальный id метки, размер задан в cascade level

## Денициализация протокола ISO14443a
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |---  |--- 
Содержание | 0x04 | 0x07 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xaf | rfid_on | 0xcb
- rfid_on - 0x01: оставить включенным, 0x00: выключить. В данном коде rfid_on = 0x01

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## Выключение RFID
На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x05 | 0x07 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x00 | 0x22 | 0x00 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор