# rfid_writer
Скрипт на Python для чтения с ST25R3911B-DISCO в режиме polling

Данный скрипт при чтении ответа на каждую команду выводит: протокол в шестнадцатеричном формате, количество переданных байт и количество принятых байт в десятичном формате.

При чтении данных с метки выводится дополнительная строка вида:
Байт | 0 | 1-2| 3 | 4-6 | 7-17 
--- | --- | --- | --- |--- |--- 
Содержание |  сol | ATQA | cascade level | sak | uid

# Требования
Установленная библиотека pyusb.

# Условности
Посылка может быть не более 64 байт.

Пакет может состоять из нескольких посылок и быть больше 64 байт.

TID при отсылке от хоста фиксировано, на производительность программы не влияет.

# Использование
На Windows просто выполнить скрипт.

На Linux вызывать через ```sudo /bin/python3 %PATH%/vscode/usb_comm.py```

# Общий вид посылки
Посылка имеет фиксированный размер 64 байта. При отсылке посылки меньшего размера будет вызвана ошибка средствами pyusb.

Необходимо "добивать" посылку до размера 64 байта, желательно не нулями (для удобства просмотра всей посылки в Wireshark).

От ПК на устройство поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |reserved | protocol | tx-prot MSB | tx-prot LSB | rx-prot MSB | rx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | 0xcb        

- TID - ID обмена, меняется с каждой отосланной посылкой
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- tx-prot - количество отосланных байт (для этого пакета) от хоста к устройству
- rx-prot - количество байт, которые ожидается принять (для данного пакета) от устройства

От устройства на ПК поступает посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 ... (8 + tx-prot - 1)| (8 + tx-prot) | (9+tx-prot) | (10+tx-prot) | (10+tx-prot + 1) ... 63 - (10+tx-prot)           
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | payload |HID status | protocol | reserved | protocol status | tx-prot MSB | tx-prot LSB| data  | protocol B  | tx-prot B | tx-prot B | 0xcb  

- TID - ID обмена, меняется с каждой отосланной посылкой
- payload - количество данных в данной посылке - пакет может быть больше этого размера
- HID status - если протокол не был обработан (из-за того что id протокола было незивестно), следующий HID пакет будет содержать байт HID status <> 0, сигнализирующий о произошедшей ошибке (некоторое время назад)
- protocol status - байт, содержащий результат команды, если была отослана команда сгенерировать данные для отправки или команда чтения (MSBit обнулен [has the MSBit cleared]) 
- tx-prot - количество отосланных байт (для этого пакета) от устройства к хосту

# Основная программа
Перед общением необходимо отыскать USB HID, с которым будет происходить общение. ST25R3911B-DISCO имеет ```PID = 0x3721```. В случае отсутствия данного устройства будет выведена ошибка.

Для Linux отключается Kernel driver.

Обязательно перед началом общения необходимо установить конфигурацию и отыскать входные и выходные конечные точки (endpoint in и endpoint out).

Общение с меткой в режиме Polling производится в цикле, на каждой итерации выполняется следующее:

- инициализация общеняя по протоколу iso14443a;
- считывание и вывод полученного uid;
- деинициализация общения по протоколу и выключение RFID (одной командой).

# Функции
## usb_write(device, msg)
Отправляет байтовый массив ```msg``` на USB HID ```device```. Пример использования:
```
msg = bytearray([0x04, 0x00, 0xcb])
usb_write(device, msg)
``` 
## usb_read(device)
Считывает байтовый массив от USB HID ```device```, возвращает сообщение от устройства ST25R3911B-DISCO размера ```8+tx_sz``` (отбрасывает мусорные байты). Выводит на экран номер протокола в шестнадцатеричном формате, ```tx_sz``` и ```rx_sz``` в десятичном формате.
## read_reg_x23(device)
Считывание регистра показа калибровки антенны (Antenna Calibration Display Register, адрес 0x23).
Посылка команды на считывание с регистра показа калибровки антенны ST25R3911 (код команды считывания с регистра - 0x69) имеет следующий вид:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | 0x00 | 0x06 | 0x00 | 0x69 | 0x00 | 0x01 | 0x00 | 0x01 | 0x23 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | TID | 0x06 | 0x00 | 0x69 | 0x00 | 0x00 | 0x00 | 0x01 | 0x70 | мусор

## iso14443a_on(device)
Отправка команды инициализации протокола ISO14443a на USB HID ```device```.

На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- 
Содержание | 0x01 | 0x06 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xa0 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## rfid_on(device)
Отправка команды на включение RFID на USB HID ```device```.

На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x02 | 0x07 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x00 | 0x22 | 0x01 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## rfid_read(device)
Чтение данных с RFID метки.

На USB HID ```device``` посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x03 | 0x08 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x11 | 0xa1 | 0x26| 0x01 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9-10 | 11 | 12-14| 15-25 | 26-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x16 | 0x00 | 0x44 | 0x00 | 0x04 | 0x00 | 0x11 | сol | ATQA | cascade level | sak | uid | мусор
- col - колонка
- ATQA - код производителя
- cascade level - 1: 4-битный uid, 2: 7-битный, 3: 10-битный
- sak - вид метки
- uid - уникальный id метки, размер задан в cascade level

## iso14443a_off(device)
Отправка команды денициализации протокола ISO14443a на USB HID ```device```.

На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |---  |--- 
Содержание | 0x04 | 0x07 | 0x00 | 0x44 | 0x00 | 0x01 | 0x00 | 0x00 | 0xaf | rfid_on | 0xcb
- rfid_on - 0x01: оставить включенным, 0x00: выключить. В данном коде rfid_on = 0x00

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор

## rfid_off(device)
Отправка команды выключения RFID на USB HID ```device```.

На устройство посылается:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |--- |--- |---
Содержание | 0x05 | 0x07 | 0x00 | 0x44 | 0x00 | 0x02 | 0x00 | 0x00 | 0x22 | 0x00 | 0xcb

В ответ приходит посылка вида:

Байт | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8-63 
--- | --- | --- | --- |--- |--- |--- |--- |--- |---
Содержание | TID | 0x05 | 0x00 | 0x44 | 0x00 | 0x00 | 0x00 | 0x00 | мусор